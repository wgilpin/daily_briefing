# Implementation Plan: Newsletter Audio Generation

**Branch**: `007-newsletter-audio` | **Date**: 2026-02-05 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/007-newsletter-audio/spec.md`

## Summary

Implement automatic text-to-speech conversion of daily newsletter digests using ElevenLabs API. The system will generate MP3 audio files with alternating male and female voices for each newsletter item, saving the audio alongside the markdown digest. Integration point is the post-consolidation phase in the existing newsletter generation pipeline.

## Technical Context

**Language/Version**: Python 3.13+
**Primary Dependencies**: ElevenLabs Python SDK, existing Flask stack
**Storage**: File-based (MP3 files in data/output/, credentials in .env)
**Testing**: pytest with mocked ElevenLabs API responses
**Target Platform**: Linux server (Coolify deployment)
**Project Type**: Single project (extension to existing src/ structure)
**Performance Goals**: Audio generation completes within 5 minutes for newsletters up to 50 items
**Constraints**: Sequential TTS API calls (not parallel), must not block newsletter generation on failure
**Scale/Scope**: Single-user application, ~10-20 newsletter items per digest, ~1-3 digests per day

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Initial Compliance Review (Pre-Phase 0)

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Technology Stack** | ✅ PASS | Python 3.13+, uv for package management, no new databases |
| **II. Strong Typing** | ✅ PASS | Will use Pydantic models for audio configuration, voice config, TTS requests/responses |
| **III. Backend TDD** | ✅ PASS | Audio generation service is backend logic - will write tests first |
| **IV. Test Isolation** | ✅ PASS | ElevenLabs API will be mocked in tests (no remote API calls) |
| **V. Simplicity First** | ✅ PASS | Direct integration, no unnecessary abstractions, reuse existing patterns |
| **VI. Feature Discipline** | ✅ PASS | Scope limited to spec requirements - no extra features |
| **VII. Code Quality Gates** | ✅ PASS | Will run ruff and mypy before commits |

**Gate Result**: ✅ PROCEED TO PHASE 0

### Post-Phase 1 Design Review

**Re-evaluation Date**: 2026-02-05

| Principle | Status | Notes |
|-----------|--------|-------|
| **I. Technology Stack** | ✅ PASS | ElevenLabs SDK added via uv, file-based MP3 storage (no new databases) |
| **II. Strong Typing** | ✅ PASS | All models defined with Pydantic (AudioConfig, NewsletterItem, AudioSegment, TTSRequest, AudioGenerationResult) - no `Any` types, no plain `dict` |
| **III. Backend TDD** | ✅ PASS | Test-first approach documented in quickstart.md - tests for markdown parser, TTS service, audio generator |
| **IV. Test Isolation** | ✅ PASS | Mock patterns defined for ElevenLabs API - no remote calls in tests |
| **V. Simplicity First** | ✅ PASS | Simple sequential processing, direct SDK integration, no complex abstractions |
| **VI. Feature Discipline** | ✅ PASS | Design exactly matches spec - no feature creep |
| **VII. Code Quality Gates** | ✅ PASS | ruff and mypy commands documented in quickstart.md |

**Final Gate Result**: ✅ PROCEED TO IMPLEMENTATION

No violations requiring justification. Design fully complies with constitution.

## Project Structure

### Documentation (this feature)

```text
specs/007-newsletter-audio/
├── plan.md              # This file
├── research.md          # Phase 0: ElevenLabs API research
├── data-model.md        # Phase 1: Audio generation data models
├── quickstart.md        # Phase 1: Developer setup guide
├── contracts/           # Phase 1: API interaction patterns
│   └── elevenlabs-tts-integration.md
└── tasks.md             # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── models/
│   └── audio_models.py              # NEW: Pydantic models for audio generation
├── services/
│   └── audio/
│       ├── __init__.py              # NEW
│       ├── tts_service.py           # NEW: ElevenLabs TTS integration
│       ├── markdown_parser.py       # NEW: Parse newsletter markdown for TTS
│       └── audio_generator.py       # NEW: Orchestrates TTS + file I/O
├── newsletter/
│   └── storage.py                   # MODIFY: Add audio generation hook
└── web/
    └── feed_routes.py               # MODIFY: Trigger audio after consolidation

tests/
├── unit/
│   └── services/
│       └── audio/
│           ├── test_tts_service.py          # NEW
│           ├── test_markdown_parser.py      # NEW
│           └── test_audio_generator.py      # NEW
└── integration/
    └── test_newsletter_audio_workflow.py    # NEW

data/
└── output/
    └── *.mp3                        # NEW: Generated audio files
```

**Structure Decision**: Extends existing single-project structure with new `src/services/audio/` module for TTS functionality. Follows established patterns in codebase (services/ for business logic, models/ for Pydantic types, tests/ mirrors src/).

## Complexity Tracking

No constitution violations to justify.
