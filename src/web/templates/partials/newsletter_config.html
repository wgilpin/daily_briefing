<div id="newsletter-config" class="source-config-form">
    <h4>Newsletter Configuration</h4>
    {% if newsletter_config.configured %}
    <div class="config-status configured">
        <span class="status-icon">&#10003;</span>
        <span>Configured</span>
    </div>
    {% else %}
    <div class="config-status not-configured">
        <span class="status-icon">&#10007;</span>
        <span>No senders configured</span>
    </div>
    {% endif %}

    <p class="section-description">
        Configure which newsletter senders to process and how to parse their content.
    </p>

    <h5>Configured Senders</h5>
    {% if newsletter_config.senders %}
    <div class="sender-list-table">
        <table class="senders-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Display Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for email, config in newsletter_config.senders.items() %}
                <tr class="sender-row">
                    <td class="sender-email">{{ email }}</td>
                    <td class="sender-display-name">
                        <span class="display-name-value">{{ config.get('display_name', '‚Äî') }}</span>
                        <button class="btn-icon edit-display-name-btn"
                                onclick="editDisplayName('{{ email }}', '{{ config.get('display_name', '') }}')"
                                title="Edit display name">
                            ‚úèÔ∏è
                        </button>
                    </td>
                    <td class="sender-actions">
                        <button class="btn-icon btn-danger"
                                hx-delete="{{ url_for('main.api_settings_delete_sender', email=email) }}"
                                hx-confirm="Remove {{ email }} from senders?"
                                hx-target="#newsletter-status"
                                hx-swap="innerHTML"
                                title="Delete sender">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="no-senders">No newsletter senders configured yet.</p>
    {% endif %}

    <div class="quick-add-sender">
        <h5>Quick Add Sender</h5>
        <form hx-post="{{ url_for('main.api_settings_newsletter_sender') }}"
              hx-target="#newsletter-status"
              hx-swap="innerHTML"
              class="config-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="sender_email">Email Address:</label>
                    <input type="email"
                           id="sender_email"
                           name="email"
                           required
                           placeholder="newsletter@example.com">
                </div>
                <div class="form-group">
                    <label for="sender_display_name">Display Name (optional):</label>
                    <input type="text"
                           id="sender_display_name"
                           name="display_name"
                           placeholder="e.g., Alphasignal">
                    <small class="form-hint">Friendly name for audio attribution</small>
                </div>
                <div class="form-group form-button">
                    <button type="submit" class="btn">Add Sender</button>
                </div>
            </div>
        </form>
    </div>

    <div class="newsletter-settings">
        <h5>General Settings</h5>
        <form hx-post="{{ url_for('main.api_settings_newsletter') }}"
              hx-target="#newsletter-status"
              hx-swap="innerHTML"
              class="config-form">
            <div class="form-group">
                <label for="max_emails">Max Emails per Refresh:</label>
                <input type="number"
                       id="max_emails"
                       name="max_emails_per_refresh"
                       min="1"
                       max="100"
                       value="{{ newsletter_config.max_emails or 20 }}"
                       placeholder="20">
                <small class="form-hint">Maximum number of emails to process during refresh.</small>
            </div>
            <button type="submit" class="btn">Update Newsletter Settings</button>
        </form>
    </div>
    <div id="newsletter-status"></div>
</div>

<!-- Display Name Edit Modal -->
<div id="display-name-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h4>Edit Display Name</h4>
        <form id="display-name-form">
            <input type="hidden" id="edit-sender-email" name="email">
            <div class="form-group">
                <label for="edit-display-name">Display Name:</label>
                <input type="text"
                       id="edit-display-name"
                       name="display_name"
                       placeholder="e.g., Alphasignal">
                <small class="form-hint">Leave empty to remove attribution from audio</small>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn">Save</button>
                <button type="button" class="btn btn-secondary" onclick="closeDisplayNameModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function editDisplayName(email, currentName) {
    document.getElementById('edit-sender-email').value = email;
    document.getElementById('edit-display-name').value = currentName || '';
    document.getElementById('display-name-modal').style.display = 'flex';
}

function closeDisplayNameModal() {
    document.getElementById('display-name-modal').style.display = 'none';
}

document.getElementById('display-name-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/api/settings/newsletter/display-name', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('newsletter-status').innerHTML = html;
        closeDisplayNameModal();
        // Reload page after 1 second to show updated table
        setTimeout(() => window.location.reload(), 1000);
    })
    .catch(error => {
        document.getElementById('newsletter-status').innerHTML =
            '<div class="status error">Error updating display name: ' + error + '</div>';
    });
});

// Close modal when clicking outside
document.getElementById('display-name-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDisplayNameModal();
    }
});
</script>

<style>
.form-row {
    display: flex;
    gap: 15px;
    align-items: flex-start;
    flex-wrap: wrap;
}

.form-row .form-group {
    flex: 1;
    min-width: 200px;
}

.form-row .form-button {
    flex: 0 0 auto;
    min-width: 120px;
    display: flex;
    align-items: flex-end;
}

.form-row .form-button .btn {
    margin-top: 0;
    height: 38px;
    white-space: nowrap;
    padding: 8px 16px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.form-hint {
    display: block;
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.sender-list-table {
    margin: 15px 0;
}

.senders-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
}

.senders-table th,
.senders-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.senders-table th {
    background-color: #f0f0f0;
    font-weight: 600;
    white-space: nowrap;
}

.sender-email {
    font-size: 13px;
    word-break: break-word;
}

.sender-display-name {
    display: flex;
    align-items: center;
    gap: 8px;
}

.display-name-value {
    flex: 1;
}

.sender-actions {
    text-align: center;
    width: 60px;
}

.btn-icon {
    padding: 4px 8px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    background: transparent;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.edit-display-name-btn:hover {
    background-color: #e7f3ff;
}

.btn-danger:hover {
    background-color: #ffebee;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-secondary {
    background-color: #6c757d;
}

.btn-secondary:hover {
    background-color: #5a6268;
}
</style>
